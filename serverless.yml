service: kovi-teste
custom:
  versions-prod2: true
  versions-default: false
  myStage: ${opt:stage, self:provider.stage}
  region: ${opt:region, self:provider.region}
  topic: payment-cards-events-${self:custom.myStage}
  mobileTopic: push-mobile-${self:custom.myStage}
  topicArn:
    Fn::Join:
      - ''
      - - "arn:aws:sns:${self:custom.region}:"
        - Ref: AWS::AccountId
        - ":${self:custom.topic}"
  mobileTopicArn:
    Fn::Join:
      - ''
      - - "arn:aws:sns:${self:custom.region}:"
        - Ref: AWS::AccountId
        - ":${self:custom.mobileTopic}"
  settings:
    dev:
      TRANSACTION_EVENTS_TOPIC: ${self:custom.topicArn}
      PUSH_MOBILE_TOPIC: ${self:custom.mobileTopicArn}
      TRANSACTIONS_TABLE: payment-cards-dev
      CLIENTS_TABLE: clients-dev
      ACCOUNTS_TABLE: accounts-dev
      PRIVATE_LABEL_ACCOUNTS_TABLE: private-label-accounts-dev
      PAYMENT_ACCOUNTS_TABLE: payment-accounts-dev
      PAYMENT_ACCOUNT_BALANCE_HISTORIES_TABLE: payment-account-balance-histories-dev
      STAGE: ${self:custom.myStage}
      TOPIC_ACC_EVT: arn:aws:sns:us-east-1:739649310064:accounts-events-dev
      TOPIC_TRNSCT_EVT: arn:aws:sns:us-east-1:739649310064:payment-cards-events-dev
      QUEUE_URL: https://sqs.us-east-1.amazonaws.com/739649310064/error-sns-accounts-events.fifo
  serverless-offline:
    port: 3030
  # authorizer:
  #   prod2:
  #     ${cf:api-auth-authorizer-prod2.JwtTokenAuthorizerLambdaFunctionQualifiedArn}
  #   staging:
  #     ${cf:api-auth-authorizer-staging.JwtTokenAuthorizerLambdaFunctionQualifiedArn}
  #   dev:
  #     ${cf:api-auth-authorizer-dev.JwtTokenAuthorizerLambdaFunctionQualifiedArn}
  #   sandbox:
  #     ${cf:api-auth-authorizer-sandbox.JwtTokenAuthorizerLambdaFunctionQualifiedArn}

provider:
  environment: ${self:custom.settings.${self:custom.myStage}}
  name: aws
  layers:
        # Ref name is generated by TitleCasing the layer name & appending LambdaLayer
      - {Ref: CommonLibsLambdaLayer}
  vpc:
    securityGroupIds:
      - ${ cf:SparkDXNetworkOne.SparkDXSecurityGroup }
    subnetIds:
      - ${ cf:SparkDXNetworkOne.SparkDXPrivSubnet } 
  versionFunctions: ${self:custom.versions-${self:custom.myStage}, self:custom.versions-default}
  runtime: nodejs8.10
  timeout: 30
  iamRoleStatements:
    - Effect: Allow
      Action:
        - SNS:Publish
      Resource: 
        - "${self:custom.settings.${self:custom.myStage}.TOPIC_ACC_EVT}"
        - "${self:custom.settings.${self:custom.myStage}.TOPIC_TRNSCT_EVT}"
        
    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:ListStreams
      Resource:
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.TRANSACTIONS_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.TRANSACTIONS_TABLE}/*"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.ACCOUNTS_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.ACCOUNTS_TABLE}/*"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.PRIVATE_LABEL_ACCOUNTS_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.PRIVATE_LABEL_ACCOUNTS_TABLE}/*"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.PAYMENT_ACCOUNTS_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.PAYMENT_ACCOUNTS_TABLE}/*"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.CLIENTS_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.CLIENTS_TABLE}/*"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.PAYMENT_ACCOUNT_BALANCE_HISTORIES_TABLE}"
        - "arn:aws:dynamodb:us-east-1:*:table/${self:custom.settings.${self:custom.myStage}.PAYMENT_ACCOUNT_BALANCE_HISTORIES_TABLE}/*"

    - Effect: Allow
      Action:
        - SNS:Publish
        - SNS:ListSubscriptions
        - SNS:setSubscriptionAttributes
      Resource:
        - "${self:custom.topicArn}"
        - "${self:custom.mobileTopicArn}"

layers:
  commonLibs:
    path: layer
    compatibleRuntimes:
      - nodejs8.10

functions: # TODO: change the handlers
  # dispatcherLogAll:
  #     handler: dispatchers/log-all.handler
  #     events:
  #       - sns: 
  #           arn: "${self:custom.topicArn}"
  #           topicName: "${self:custom.topic}"
  #           displayName: transa-evt
  endpointPostInsertInque:
    handler: endpoints/postIDcharges.handler
    events:
      - http:
          path: /{id}/charges
          method: post 
          authorizer:
            arn: "${self:custom.authorizer.${self:custom.myStage}}"
            name: jwtToken
            resultTtlInSeconds: 0
          cors: true
          integration: lambda
          response:
            headers:
              Content-Type: "'application/json'"
              Access-Control-Allow-Origin: "'*'"
            template: $input.path('$')
            statusCodes:
                201:
                    pattern: '' # Default response method
                400:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][0].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"
                401:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][1].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"
                403:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][3].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"
                404:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][0][4].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"
                422:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[4][2][2].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"  
                500:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][0].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"                     
                503:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][3].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"            
                504:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    pattern: '^.*[5][0][4].*$' # JSON response
                    template: $input.path("$.errorMessage") # JSON return object
                    headers:
                       Content-Type: "'application/json'"            
          request:
            template:
              application/json: '{
                 "method": "$context.httpMethod",
                 "body" : $input.json(''$''),
                 "headers": {
                   #foreach($param in $input.params().header.keySet())
                     "$param": "$util.escapeJavaScript($input.params().header.get($param))" #if($foreach.hasNext),#end
                   #end
                 },
                 "queryParams": {
                   #foreach($param in $input.params().querystring.keySet())
                     "$param": "$util.escapeJavaScript($input.params().querystring.get($param))" #if($foreach.hasNext),#end
                   #end
                 },
                 "pathParams": {
                   #foreach($param in $input.params().path.keySet())
                     "$param": "$util.escapeJavaScript($input.params().path.get($param))" #if($foreach.hasNext),#end
                   #end
                 }
               }'
 
resources:
    Resources:
      GatewayResponseDefault4XX:
        Type: 'AWS::ApiGateway::GatewayResponse'
        Properties:
          ResponseParameters:
            gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
            gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
          ResponseType: DEFAULT_4XX
          RestApiId:
            Ref: 'ApiGatewayRestApi'

plugins:
  - serverless-domain-manager
  - serverless-offline
  - serverless-plugin-tracing
